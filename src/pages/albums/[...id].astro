---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import { Image } from 'astro:assets'
import { getCollection, render } from 'astro:content'

// helpers to robustly parse dd-mm-yyyy or Date objects and format as dd-mm-yyyy
function parseToDate(value: any) {
  if (!value) return null
  if (value instanceof Date) return value
  const s = String(value)
  const m = s.match(/^(\d{2})-(\d{2})-(\d{4})$/)
  if (m) {
    return new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]))
  }
  const d = new Date(s)
  return Number.isNaN(d.getTime()) ? null : d
}

function formatDDMMYYYY(value: any) {
  const d = parseToDate(value)
  if (!d) return ''
  const day = String(d.getDate()).padStart(2, '0')
  const month = String(d.getMonth() + 1).padStart(2, '0')
  const year = d.getFullYear()
  return `${day}-${month}-${year}`
}

export async function getStaticPaths() {
  const albums = await getCollection('albums')
  return albums.map((album) => ({
    params: { id: album.id },
    props: album,
  }))
}

const album = Astro.props
const { Content } = await render(album)
---

<Layout class="max-w-3xl">
  <PageHead
    slot="head"
    title={album.data.title}
    description={album.data.description}
  />
  <Breadcrumbs
    items={[
      { href: '/albums', label: 'Album reviews', icon: 'lucide:disc' },
      { label: album.data.title, icon: 'lucide:disc-3' },
    ]}
  />

  <section class="mt-4 flex flex-col gap-6">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:gap-6">
      {
        album.data.image ? (
          <Image
            src={album.data.image}
            alt={album.data.title}
            width={400}
            height={400}
            class="h-40 w-40 rounded-sm object-cover shadow-lg sm:h-48 sm:w-48"
          />
        ) : (
          <div class="border-border/70 bg-muted/10 text-muted-foreground flex h-40 w-40 items-center justify-center rounded-sm border text-[0.6rem] tracking-[0.24em] uppercase sm:h-48 sm:w-48">
            album
          </div>
        )
      }

      <div class="space-y-2">
        <h1 class="text-2xl font-medium tracking-[0.18em] uppercase">
          {album.data.title}
        </h1>
        <p class="text-muted-foreground text-xs tracking-[0.2em] uppercase">
          {album.data.artists?.join(', ') ?? 'Unknown artist'}
          {' '}&bull; {album.data.year}
        </p>
        {
          album.data.date && (
            <p class="text-muted-foreground text-xs">
              Reviewed {formatDDMMYYYY(album.data.date)}
            </p>
          )
        }
        {
          typeof album.data.rating === 'number' && (
            <p class="font-mono text-lg">
              <span class="text-muted-foreground text-xs tracking-[0.2em] uppercase">
                rating
              </span>
              <br />
              {album.data.rating}
              <span class="text-muted-foreground text-xs">/100</span>
            </p>
          )
        }
      </div>
    </div>

    <article class="prose max-w-none">
      <Content />
    </article>
  </section>
</Layout>
