---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import { Image } from 'astro:assets'
import { getCollection, render } from 'astro:content'

// helpers to robustly parse dd-mm-yyyy or Date objects and format as dd-mm-yyyy
function parseToDate(value: any) {
  if (!value) return null
  if (value instanceof Date) return value
  const s = String(value)
  const m = s.match(/^(\d{2})-(\d{2})-(\d{4})$/)
  if (m) {
    return new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]))
  }
  const d = new Date(s)
  return Number.isNaN(d.getTime()) ? null : d
}

function formatDDMMYYYY(value: any) {
  const d = parseToDate(value)
  if (!d) return ''
  const day = String(d.getDate()).padStart(2, '0')
  const month = String(d.getMonth() + 1).padStart(2, '0')
  const year = d.getFullYear()
  return `${day}-${month}-${year}`
}

const rawAlbums = await getCollection('albums')
const perfect = rawAlbums.filter((a) => a.data.rating === 100)
const albums = await Promise.all(
  perfect.map(async (entry) => {
    const { Content } = await render(entry)
    return { ...entry, Content }
  }),
)
---

<Layout class="max-w-3xl">
  <PageHead
    slot="head"
    title="100/100 Albums"
    description="Albums that earned a perfect score."
  />
  <Breadcrumbs
    items={[
      { href: '/albums', label: 'Album reviews', icon: 'lucide:disc' },
      { label: '100/100', icon: 'lucide:sparkles' },
    ]}
  />

  <p class="text-muted-foreground mb-6 text-sm">peak alert</p>

  {
    albums.length === 0 ? (
      <p class="text-muted-foreground text-sm">
        No perfect scores yet. The bar is high.
      </p>
    ) : (
      <ul class="fade-in-up-soft flex flex-col gap-y-4">
        {albums.map((album) => (
          <li>
            <a
              href={`/albums/${album.id}`}
              class="group bg-background/40 hover:bg-muted/40 block rounded-xl border p-4 transition-all duration-500 ease-out hover:-translate-y-1 sm:p-5"
            >
              <div class="grid grid-cols-[auto,1fr,auto] items-start gap-4 sm:gap-6">
                {album.data.image ? (
                  <Image
                    src={album.data.image}
                    alt={album.data.title}
                    width={320}
                    height={320}
                    class="h-24 w-24 rounded-sm object-cover shadow-lg sm:h-28 sm:w-28"
                  />
                ) : (
                  <div class="border-border/70 bg-muted/10 text-muted-foreground flex h-24 w-24 items-center justify-center rounded-sm border text-[0.6rem] tracking-[0.24em] uppercase sm:h-28 sm:w-28">
                    album
                  </div>
                )}

                <div class="space-y-1.5">
                  <h3 class="text-lg font-medium tracking-[0.18em] uppercase">
                    {album.data.title}
                  </h3>
                  <p class="text-muted-foreground text-xs tracking-[0.2em] uppercase">
                    {album.data.artists?.join(', ') ?? 'Unknown artist'}
                    {album.data.year && <> &bull; {album.data.year}</>}
                    {album.data.date && (
                      <> &bull; {formatDDMMYYYY(album.data.date)}</>
                    )}
                  </p>
                </div>

                <div class="flex flex-col items-end gap-1 text-right">
                  <span class="text-primary font-mono text-2xl leading-none">
                    100
                    <span class="text-muted-foreground text-xs">/100</span>
                  </span>
                </div>
              </div>

              <article class="prose small text-foreground/90 mt-4 max-w-none text-sm">
                <album.Content />
              </article>
            </a>
          </li>
        ))}
      </ul>
    )
  }
</Layout>
