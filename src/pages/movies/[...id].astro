---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import { Image } from 'astro:assets'
import { getCollection, render } from 'astro:content'

export async function getStaticPaths() {
  const movies = await getCollection('movies')
  return movies.map((movie) => ({
    params: { id: movie.id },
    props: movie,
  }))
}

const movie = Astro.props
const { Content } = await render(movie)

const rating = movie.data.rating
const starValue =
  typeof rating === 'number' ? Math.round(rating / 20) : null
const starsString =
  typeof starValue === 'number'
    ? '★'.repeat(starValue) + '☆'.repeat(5 - starValue)
    : null
---

<Layout class="max-w-3xl">
  <PageHead
    slot="head"
    title={movie.data.title}
    description={movie.data.description}
  />
  <Breadcrumbs
    items={[
      { href: '/movies', label: 'Movie reviews', icon: 'lucide:film' },
      { label: movie.data.title, icon: 'lucide:clapperboard' },
    ]}
  />

  <section class="mt-4 flex flex-col gap-6">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:gap-6">
      {
        movie.data.image ? (
          <Image
            src={movie.data.image}
            alt={movie.data.title}
            width={400}
            height={560}
            class="h-48 w-32 rounded-sm object-cover shadow-lg sm:h-56 sm:w-36"
          />
        ) : (
          <div class="flex h-48 w-32 items-center justify-center rounded-sm border border-border/70 bg-muted/10 text-[0.6rem] uppercase tracking-[0.24em] text-muted-foreground sm:h-56 sm:w-36">
            film
          </div>
        )
      }

      <div class="flex flex-col gap-3">
        <div>
          <h1 class="text-2xl font-medium tracking-[0.16em] uppercase">
            {movie.data.title}
          </h1>
          <p class="text-xs uppercase tracking-[0.2em] text-muted-foreground">
            {movie.data.year}
            {
              movie.data.directors && movie.data.directors.length > 0 && (
                <>
                  {' '}
                  &bull; {movie.data.directors.join(', ')}
                </>
              )
            }
            {
              typeof movie.data.runtimeMinutes === 'number' && (
                <>
                  {' '}
                  &bull; {movie.data.runtimeMinutes} min
                </>
              )
            }
          </p>
        </div>

        {
          typeof rating === 'number' && (
            <div class="flex items-baseline gap-3 text-sm">
              {starsString && (
                <span class="font-medium tracking-[0.2em] text-primary">
                  {starsString}
                </span>
              )}
              <span class="font-mono text-lg">
                {rating}
                <span class="text-xs text-muted-foreground">/100</span>
              </span>
            </div>
          )
        }

        {movie.data.description && (
          <p class="text-sm text-muted-foreground">
            {movie.data.description}
          </p>
        )}
      </div>
    </div>

    <article class="prose max-w-none">
      <Content />
    </article>
  </section>
</Layout>

