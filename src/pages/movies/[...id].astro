---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import { Image } from 'astro:assets'
import { getCollection, render } from 'astro:content'

// helpers to robustly parse dd-mm-yyyy or Date objects and format as dd-mm-yyyy
function parseToDate(value: any) {
  if (!value) return null
  if (value instanceof Date) return value
  const s = String(value)
  const m = s.match(/^(\d{2})-(\d{2})-(\d{4})$/)
  if (m) {
    return new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]))
  }
  const d = new Date(s)
  return Number.isNaN(d.getTime()) ? null : d
}

function formatDDMMYYYY(value: any) {
  const d = parseToDate(value)
  if (!d) return ''
  const day = String(d.getDate()).padStart(2, '0')
  const month = String(d.getMonth() + 1).padStart(2, '0')
  const year = d.getFullYear()
  return `${day}-${month}-${year}`
}

export async function getStaticPaths() {
  const movies = await getCollection('movies')
  return movies.map((movie) => ({
    params: { id: movie.id },
    props: movie,
  }))
}

const movie = Astro.props
const { Content } = await render(movie)

const rating = movie.data.rating
const starValue = typeof rating === 'number' ? Math.round(rating / 20) : null
const starsString =
  typeof starValue === 'number'
    ? '★'.repeat(starValue) + '☆'.repeat(5 - starValue)
    : null
---

<Layout class="max-w-3xl">
  <PageHead
    slot="head"
    title={movie.data.title}
    description={movie.data.description}
  />
  <Breadcrumbs
    items={[
      { href: '/movies', label: 'Movie reviews', icon: 'lucide:film' },
      { label: movie.data.title, icon: 'lucide:clapperboard' },
    ]}
  />

  <section class="mt-4 flex flex-col gap-6">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:gap-6">
      {
        movie.data.image ? (
          <Image
            src={movie.data.image}
            alt={movie.data.title}
            width={400}
            height={560}
            class="h-48 w-32 rounded-sm object-cover shadow-lg sm:h-56 sm:w-36"
          />
        ) : (
          <div class="border-border/70 bg-muted/10 text-muted-foreground flex h-48 w-32 items-center justify-center rounded-sm border text-[0.6rem] tracking-[0.24em] uppercase sm:h-56 sm:w-36">
            film
          </div>
        )
      }

      <div class="flex flex-col gap-3">
        <div>
          <h1 class="text-2xl font-medium tracking-[0.16em] uppercase">
            {movie.data.title}
          </h1>
          <p class="text-muted-foreground text-xs tracking-[0.2em] uppercase">
            {movie.data.year}
            {
              movie.data.directors && movie.data.directors.length > 0 && (
                <> &bull; {movie.data.directors.join(', ')}</>
              )
            }
            {
              typeof movie.data.runtimeMinutes === 'number' && (
                <> &bull; {movie.data.runtimeMinutes} min</>
              )
            }
          </p>
          {
            movie.data.date && (
              <p class="text-muted-foreground text-xs">
                Reviewed {formatDDMMYYYY(movie.data.date)}
              </p>
            )
          }
          {
            typeof rating === 'number' && (
              <div class="flex items-baseline gap-3 text-sm">
                {starsString && (
                  <span class="text-primary font-medium tracking-[0.2em]">
                    {starsString}
                  </span>
                )}
                <span class="font-mono text-lg">
                  {rating}
                  <span class="text-muted-foreground text-xs">/100</span>
                </span>
              </div>
            )
          }
        </div>
      </div>
    </div>

    <article class="prose max-w-none">
      <Content />
    </article>
  </section>
</Layout>
