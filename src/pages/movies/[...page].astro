---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import Search from '@/components/Search'
import Layout from '@/layouts/Layout.astro'
import { Image } from 'astro:assets'
import { getCollection, render } from 'astro:content'

function parseToDate(value: any) {
  if (!value) return null
  if (value instanceof Date) return value
  const s = String(value)
  const m = s.match(/^(\d{2})-(\d{2})-(\d{4})$/)
  if (m) {
    return new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]))
  }
  const d = new Date(s)
  return Number.isNaN(d.getTime()) ? null : d
}

function formatDDMMYYYY(value: any) {
  const d = parseToDate(value)
  if (!d) return ''
  const day = String(d.getDate()).padStart(2, '0')
  const month = String(d.getMonth() + 1).padStart(2, '0')
  const year = d.getFullYear()
  return `${day}-${month}-${year}`
}

const rawMovies = await getCollection('movies')
rawMovies.sort((a, b) => {
  const at = parseToDate(a.data.date)?.getTime() || 0
  const bt = parseToDate(b.data.date)?.getTime() || 0
  return bt - at
})

const movies = await Promise.all(
  rawMovies.map(async (entry) => {
    const { Content } = await render(entry)
    const rating = entry.data.rating
    const starValue =
      typeof rating === 'number' ? Math.round(rating / 20) : null
    const starsString =
      typeof starValue === 'number'
        ? '★'.repeat(starValue) + '☆'.repeat(5 - starValue)
        : null
    return { ...entry, Content, starsString }
  }),
)

const movieSearchData = rawMovies.map((movie) => ({
  id: movie.id,
  title: movie.data.title,
  url: `/movies/${movie.id}`,
  description: movie.data.directors?.join(', '),
}))

export async function getStaticPaths() {
  function parseToDate(value: any) {
    if (!value) return null
    if (value instanceof Date) return value
    const s = String(value)
    const m = s.match(/^(\d{2})-(\d{2})-(\d{4})$/)
    if (m) {
      return new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]))
    }
    const d = new Date(s)
    return Number.isNaN(d.getTime()) ? null : d
  }

  const rawMovies = await getCollection('movies')
  rawMovies.sort((a, b) => {
    const at = parseToDate(a.data.date)?.getTime() || 0
    const bt = parseToDate(b.data.date)?.getTime() || 0
    return bt - at
  })

  const movies = await Promise.all(
    rawMovies.map(async (entry) => {
      const { Content } = await render(entry)
      const rating = entry.data.rating
      const starValue =
        typeof rating === 'number' ? Math.round(rating / 20) : null
      const starsString =
        typeof starValue === 'number'
          ? '★'.repeat(starValue) + '☆'.repeat(5 - starValue)
          : null
      return { ...entry, Content, starsString }
    }),
  )

  const pageSize = 10
  const totalPages = Math.ceil(movies.length / pageSize)
  const pages = []

  for (let page = 1; page <= totalPages; page++) {
    const start = (page - 1) * pageSize
    const end = start + pageSize
    const pageData = movies.slice(start, end)

    pages.push({
      params: { page: page.toString() },
      props: {
        page: {
          data: pageData,
          currentPage: page,
          lastPage: totalPages,
          url: {
            current: page === 1 ? '/movies/' : `/movies/${page}/`,
            prev: page > 1 ? (page === 2 ? '/movies/' : `/movies/${page - 1}/`) : undefined,
            next: page < totalPages ? `/movies/${page + 1}/` : undefined,
          },
        },
        totalCount: movies.length,
      },
    })
  }

  return pages
}

interface Props {
  page: {
    data: any[]
    currentPage: number
    lastPage: number
    url: { current: string; prev?: string; next?: string }
  }
  totalCount: number
}

const { page, totalCount } = Astro.props as Props
---

<Layout class="max-w-3xl">
  <PageHead
    slot="head"
    title="Movie Reviews"
    description="Fragments and reflections on films I can't stop thinking about."
  />
  <Breadcrumbs items={[{ label: 'Movie reviews', icon: 'lucide:film' }]} />

  <div class="mb-2 flex items-center justify-between">
    <p class="text-muted-foreground text-sm">
      {totalCount} movie{totalCount !== 1 ? 's' : ''} reviewed
    </p>
  </div>

  <div class="mb-6 flex flex-wrap gap-3">
    <a
      href="/movies/100"
      class="text-muted-foreground hover:text-foreground text-sm transition-colors"
    >
      ★ 100/100
    </a>
    <a
      href="/movies/categories"
      class="text-muted-foreground hover:text-foreground text-sm transition-colors"
    >
      Categories
    </a>
  </div>

  <div class="mb-6">
    <Search
      client:load
      items={movieSearchData}
      placeholder="Search movies..."
    />
  </div>

  {
    page.data.length === 0 ? (
      <p class="text-muted-foreground text-sm">No movie reviews found.</p>
    ) : (
      <ul class="fade-in-up-soft flex flex-col gap-y-4">
        {page.data.map((movie) => (
          <li>
            <a
              href={`/movies/${movie.id}`}
              class="group bg-background/40 hover:bg-muted/40 block rounded-xl border p-4 transition-all duration-500 ease-out hover:-translate-y-1 sm:p-5"
            >
              <div class="grid grid-cols-[auto,1fr,auto] items-start gap-4 sm:gap-6">
                {movie.data.image ? (
                  <Image
                    src={movie.data.image}
                    alt={movie.data.title}
                    width={320}
                    height={320}
                    class="h-24 w-24 rounded-sm object-cover shadow-lg sm:h-28 sm:w-28"
                  />
                ) : (
                  <div class="border-border/70 bg-muted/10 text-muted-foreground flex h-24 w-24 items-center justify-center rounded-sm border text-[0.6rem] tracking-[0.24em] uppercase sm:h-28 sm:w-28">
                    movie
                  </div>
                )}

                <div class="space-y-1.5">
                  <h3 class="text-lg font-medium tracking-[0.18em] uppercase">
                    {movie.data.title}
                  </h3>
                  <p class="text-muted-foreground text-xs tracking-[0.2em] uppercase">
                    {movie.data.directors?.join(', ') ?? 'Unknown director'}
                    {movie.data.year && <> &bull; {movie.data.year}</>}
                    {movie.data.date && (
                      <> &bull; {formatDDMMYYYY(movie.data.date)}</>
                    )}
                  </p>
                </div>

                <div class="flex flex-col items-end gap-1 text-right">
                  {movie.starsString && (
                    <span class="font-mono text-lg leading-none">
                      {movie.starsString}
                    </span>
                  )}
                </div>
              </div>

              <article class="prose small text-foreground/90 mt-4 max-w-none text-sm">
                <movie.Content />
              </article>
            </a>
          </li>
        ))}
      </ul>
    )
  }

  <div class="mt-8 flex items-center justify-between gap-4">
    {
      page.url.prev ? (
        <a
          href={page.url.prev}
          class="text-foreground hover:text-foreground/75 text-sm transition-colors"
        >
          ← Previous
        </a>
      ) : (
        <div />
      )
    }
    <p class="text-muted-foreground text-sm">
      Page {page.currentPage} of {page.lastPage}
    </p>
    {
      page.url.next ? (
        <a
          href={page.url.next}
          class="text-foreground hover:text-foreground/75 text-sm transition-colors"
        >
          Next →
        </a>
      ) : (
        <div />
      )
    }
  </div>
</Layout>
