---
import '@/styles/global.css'
import '@/styles/typography.css'

import CursorTrail from '@/components/CursorTrail.astro'
import Footer from '@/components/Footer.astro'
import Head from '@/components/Head.astro'
import Header from '@/components/Header.astro'
import { SITE } from '@/consts'
import { cn } from '@/lib/utils'

interface Props {
  class?: string
}

const { class: className } = Astro.props
---

<!doctype html>
<html
  class="bg-background text-foreground scheme-light-dark"
  lang={SITE.locale}
  data-theme="dark"
>
  <Head>
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <slot name="head" />
  </Head>
  <body class="flex h-fit min-h-screen flex-col font-sans">
    <CursorTrail />
    <canvas
      id="starfield"
      class="pointer-events-none fixed inset-0 z-0"
      aria-hidden="true"></canvas>
    <header
      class="bg-background/50 relative sticky top-0 z-10 divide-y backdrop-blur-sm xl:divide-none"
    >
      <Header />
      <slot name="subposts-navigation" />
      <slot name="table-of-contents" />
    </header>
    <main
      class={cn(
        'relative z-10 w-full mx-auto flex grow flex-col gap-y-6 px-4',
        className,
      )}
    >
      <slot />
    </main>
    <Footer />
    <script>
      // @ts-nocheck
      const STAR_COUNT = 140
      const DUST_COUNT = 60
      const METEOR_COUNT = 2

      function startStarfield() {
        const canvas = document.getElementById('starfield')
        if (!canvas || !canvas.getContext) return
        const ctx = canvas.getContext('2d')
        if (!ctx) return

        let width = 0
        let height = 0
        let stars = []
        let dust = []
        let meteors = []
        let frameId = 0

        function createStars() {
          stars = Array.from({ length: STAR_COUNT }, () => {
            const colors = [
              '#ffffff',
              '#e0e0ff',
              '#ffe0e0',
              '#e0ffe0',
              '#e0f0ff',
            ]
            return {
              x: Math.random() * width,
              y: Math.random() * height,
              r: 0.5 + Math.random() * 2,
              vy: (Math.random() - 0.5) * 0.02,
              vx: (Math.random() - 0.5) * 0.02,
              tw: Math.random() * Math.PI * 2,
              pulseSpeed: 800 + Math.random() * 800,
              color: colors[Math.floor(Math.random() * colors.length)],
              baseAlpha: Math.random() * 0.5 + 0.3,
            }
          })
        }

        function createDust() {
          dust = Array.from({ length: DUST_COUNT }, () => ({
            x: Math.random() * width,
            y: Math.random() * height,
            r: 0.15 + Math.random() * 0.5,
            vy: (Math.random() - 0.5) * 0.01,
            vx: (Math.random() - 0.5) * 0.01,
            tw: Math.random() * Math.PI * 2,
            pulseSpeed: 3000 + Math.random() * 3000,
            color: '#b8a8ff',
            baseAlpha: Math.random() * 0.15 + 0.02,
          }))
        }

        function createMeteors() {
          meteors = Array.from({ length: METEOR_COUNT }, () => ({
            x: Math.random() * width,
            y: Math.random() * height * 0.3,
            r: 1.5 + Math.random() * 2.5,
            vx: 2 + Math.random() * 3,
            vy: 0.5 + Math.random() * 1.5,
            life: 1,
            maxLife: 1,
            color: '#ffddaa',
            trailLength: 60,
          }))
        }

        function resize() {
          width = window.innerWidth
          height = window.innerHeight
          canvas.width = width
          canvas.height = height
          createStars()
          createDust()
          createMeteors()
        }

        function drawGradientBg() {
          // Create gradient background for added depth
          const gradient = ctx.createRadialGradient(
            width / 2,
            height / 3,
            0,
            width / 2,
            height,
            Math.max(width, height),
          )
          gradient.addColorStop(0, 'rgba(50, 30, 80, 0.04)')
          gradient.addColorStop(0.5, 'rgba(15, 8, 30, 0.02)')
          gradient.addColorStop(1, 'rgba(0, 0, 0, 0)')
          ctx.fillStyle = gradient
          ctx.fillRect(0, 0, width, height)
        }

        function draw(time) {
          if (!width || !height) return

          // Create slight fade trail effect
          ctx.fillStyle = 'rgba(1, 1, 2, 0.04)'
          ctx.fillRect(0, 0, width, height)

          const t = time || performance.now()

          // Draw stars
          for (const star of stars) {
            star.y += star.vy
            star.x += star.vx

            // Wrap around
            if (star.x > width + 10) star.x = -10
            if (star.x < -10) star.x = width + 10
            if (star.y > height + 10) {
              star.y = -10
              star.x = Math.random() * width
            }

            // Pulsing twinkling effect
            const alpha =
              star.baseAlpha +
              0.6 * Math.abs(Math.sin(t / star.pulseSpeed + star.tw))
            ctx.beginPath()
            ctx.arc(star.x, star.y, star.r, 0, Math.PI * 2)
            ctx.fillStyle = star.color
            ctx.globalAlpha = alpha
            ctx.fill()

            // Add subtle glow
            if (alpha > 0.6) {
              ctx.shadowColor = star.color
              ctx.shadowBlur = star.r * 1.5
              ctx.fill()
              ctx.shadowBlur = 0
            }
          }

          // Draw dust particles
          for (const d of dust) {
            d.y += d.vy
            d.x += d.vx

            // Wrap around
            if (d.x > width + 10) d.x = -10
            if (d.x < -10) d.x = width + 10
            if (d.y > height + 10) {
              d.y = -10
              d.x = Math.random() * width
            }

            const alpha =
              d.baseAlpha *
              (0.3 + 0.7 * Math.abs(Math.sin(t / d.pulseSpeed + d.tw)))
            ctx.beginPath()
            ctx.arc(d.x, d.y, d.r, 0, Math.PI * 2)
            ctx.fillStyle = d.color
            ctx.globalAlpha = alpha * 0.5
            ctx.fill()
          }

          // Draw meteors
          for (let i = meteors.length - 1; i >= 0; i--) {
            const meteor = meteors[i]
            meteor.x += meteor.vx
            meteor.y += meteor.vy
            meteor.life -= 0.005

            if (meteor.life <= 0) {
              meteors.splice(i, 1)
              // Spawn new meteor less frequently
              if (Math.random() > 0.92) {
                meteors.push({
                  x: Math.random() * width * 1.2 - width * 0.1,
                  y: Math.random() * height * 0.25,
                  r: 1.5 + Math.random() * 2.5,
                  vx: 2 + Math.random() * 3,
                  vy: 0.5 + Math.random() * 1.5,
                  life: 1,
                  maxLife: 1,
                  color: '#ffddaa',
                  trailLength: 60,
                })
              }
            } else {
              const alpha =
                meteor.life *
                0.7 *
                (0.4 + 0.6 * Math.sin(meteor.life * Math.PI))
              ctx.globalAlpha = alpha
              ctx.globalCompositeOperation = 'lighter'

              // Draw meteor trail
              ctx.strokeStyle = meteor.color
              ctx.lineWidth = meteor.r
              ctx.lineCap = 'round'
              ctx.lineJoin = 'round'
              ctx.beginPath()
              ctx.moveTo(
                meteor.x - meteor.vx * meteor.trailLength,
                meteor.y - meteor.vy * meteor.trailLength,
              )
              ctx.lineTo(meteor.x, meteor.y)
              ctx.stroke()

              // Draw meteor head with glow
              ctx.shadowColor = '#ffeeaa'
              ctx.shadowBlur = 20
              ctx.fillStyle = meteor.color
              ctx.beginPath()
              ctx.arc(meteor.x, meteor.y, meteor.r, 0, Math.PI * 2)
              ctx.fill()
              ctx.shadowBlur = 0

              ctx.globalCompositeOperation = 'source-over'
            }
          }

          // Draw depth gradient overlay
          drawGradientBg()

          ctx.globalAlpha = 1
          ctx.globalCompositeOperation = 'source-over'
        }

        function loop(timestamp) {
          draw(timestamp)
          frameId = requestAnimationFrame(loop)
        }

        resize()
        cancelAnimationFrame(frameId)
        loop(0)
        window.addEventListener('resize', resize)

        return () => {
          window.removeEventListener('resize', resize)
          cancelAnimationFrame(frameId)
        }
      }

      let starfieldCleanup = null

      function setupStarfield() {
        if (starfieldCleanup) starfieldCleanup()
        starfieldCleanup = startStarfield()
      }

      document.addEventListener('astro:page-load', setupStarfield)
    </script>
  </body>
</html>
